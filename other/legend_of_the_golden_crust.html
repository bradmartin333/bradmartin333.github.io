<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Legend of the Golden Crust: Combat Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            background-color: #222;
            color: #fff;
            font-family: 'Press Start 2P', cursive, monospace;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 4/3;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            image-rendering: pixelated;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #hud {
            padding: 15px;
            text-shadow: 2px 2px 0 #000;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .bar-container {
            margin-bottom: 5px;
        }

        #hp-bar {
            width: 100px;
            height: 10px;
            background: #555;
            border: 2px solid #fff;
            display: inline-block;
        }

        #hp-fill {
            width: 100%;
            height: 100%;
            background: #0f0;
            transition: width 0.2s;
        }

        #message-box {
            background: rgba(0, 0, 0, 0.9);
            border: 4px solid #fff;
            margin: 20px;
            padding: 20px;
            min-height: 100px;
            display: none;
            pointer-events: auto;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.5;
            position: absolute;
            bottom: 20%;
            left: 10%;
            right: 10%;
            z-index: 20;
        }

        #lore-screen,
        #start-screen,
        #win-screen,
        #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
            pointer-events: auto;
            text-align: center;
        }

        h1 {
            color: #FFD700;
            text-shadow: 4px 4px 0 #8B4513;
            margin-bottom: 20px;
            font-size: 20px;
            line-height: 1.5;
            padding: 0 10px;
        }

        button {
            background: #FFD700;
            border: 4px solid #8B4513;
            color: #5d2e0b;
            font-family: 'Press Start 2P', cursive;
            padding: 15px 20px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.1s;
        }

        button:active {
            transform: scale(0.95);
        }

        button:hover {
            background: #fff;
        }

        .hidden {
            display: none !important;
        }

        .clue-text {
            color: #4db8ff;
            margin-bottom: 15px;
        }

        /* Mobile Controls */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: none;
            pointer-events: auto;
            z-index: 25;
            justify-content: space-between;
            align-items: flex-end;
        }

        @media (hover: none) and (pointer: coarse) {
            #controls {
                display: flex;
            }
        }

        .dpad {
            width: 140px;
            height: 140px;
            position: relative;
        }

        .action-btn-container {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
            margin-right: 10px;
        }

        .d-btn,
        .action-btn {
            position: absolute;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            backdrop-filter: blur(2px);
        }

        .d-btn {
            width: 45px;
            height: 45px;
        }

        .action-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 100, 100, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
        }

        .d-btn:active,
        .action-btn:active {
            background: rgba(255, 255, 255, 0.5);
        }

        .up {
            top: 0;
            left: 47px;
        }

        .down {
            bottom: 0;
            left: 47px;
        }

        .left {
            top: 47px;
            left: 0;
        }

        .right {
            top: 47px;
            right: 0;
        }
    </style>
</head>

<body>

    <div id="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <div id="ui-layer">
            <div id="hud">
                <div>
                    <div class="bar-container">HP: <div id="hp-bar">
                            <div id="hp-fill"></div>
                        </div>
                    </div>
                    <div>SALSAS: <span id="tokens-found">0</span>/5</div>
                    <div id="powerup-status" style="color: yellow; font-size: 10px; margin-top:5px; height:12px;"></div>
                </div>
            </div>

            <div id="controls">
                <div class="dpad">
                    <div class="d-btn up" data-key="ArrowUp"></div>
                    <div class="d-btn down" data-key="ArrowDown"></div>
                    <div class="d-btn left" data-key="ArrowLeft"></div>
                    <div class="d-btn right" data-key="ArrowRight"></div>
                </div>
                <div class="action-btn-container">
                    <div class="action-btn" data-key="Space">CHEESE<br>SHOT</div>
                </div>
            </div>

            <div id="message-box">
                <p id="message-text"></p>
                <button id="close-msg">CONTINUE</button>
            </div>
        </div>

        <div id="lore-screen">
            <h1 style="font-size: 16px;">THE LEGEND OF THE GOLDEN CRUST</h1>
            <div style="font-size: 10px; line-height: 1.8; max-width: 650px; padding: 20px; text-align: left;">
                <p>Long ago, on the mystical campus of Universidad de las Delicias, there existed a legendary empanada
                    known as <span style="color: #FFD700;">THE GOLDEN CRUST</span>.</p>

                <p>Baked by the ancient Baker-Wizard Don Horneado, this empanada contained the perfect balance of
                    flavor, crunch, and magical sustenance.</p>

                <p>But the recipe was lost to time, scattered across <span style="color: #ff6b6b;">5 Sacred Salsa
                        Jars</span> hidden throughout the campus grounds.</p>

                <p>Now, as finals week approaches, the campus has been overrun by desperate, hungry students, each more
                    ravenous than the last:</p>

                <p style="margin-left: 20px;">
                    <span style="color: #ff4444;">• PROFESSORS</span> - Elite hunters with decades of food-finding
                    experience<br>
                    <span style="color: #ff8844;">• GRAD STUDENTS</span> - Caffeinated and relentless pursuers<br>
                    <span style="color: #ffaa44;">• RAs</span> - Broke and hungry, they hunt in greater numbers
                </p>

                <p>You are the last empanada descendant. Navigate the treacherous campus, avoid the buildings and
                    statues, defend yourself with molten cheese shots, and collect all 5 salsas to uncover the ancient
                    recipe!</p>
            </div>
            <button id="lore-continue-btn">BEGIN YOUR JOURNEY</button>
        </div>

        <div id="start-screen" class="hidden">
            <h1>THE LEGEND OF<br>THE GOLDEN CRUST</h1>
            <p style="font-size: 12px; line-height: 20px; max-width: 600px; padding: 20px;">
                Survive the hungry horde on campus!<br><br>
                Find the 5 Ancient Salsas to reveal the truth.<br><br>
                <strong>Controls:</strong><br>
                Arrow Keys / D-Pad to Move<br>
                SPACE / Button to Shoot Molten Cheese
            </p>
            <button id="start-btn">START ADVENTURE</button>
        </div>

        <div id="game-over-screen" class="hidden">
            <h1 style="color: #ff4444;">DEVOURED!</h1>
            <p>The students enjoyed a delicious meal.</p>
            <button id="retry-btn">TRY AGAIN</button>
        </div>

        <div id="win-screen" class="hidden">
            <h1>MYSTERY SOLVED!</h1>
            <p style="color: #FFD700; margin-bottom: 20px;">You are the Supreme Snack!</p>
            <div id="final-lore"
                style="font-size: 10px; max-width: 600px; line-height: 1.6; text-align: left; background: #333; padding: 15px; border: 2px dashed #666;">
            </div>
            <button id="restart-btn">PLAY AGAIN</button>
        </div>
    </div>

    <script>
        // --- Game Engine Setup ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let gameState = 'LORE';
        let lastTime = 0;

        const keys = {
            ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false,
            w: false, s: false, a: false, d: false,
            ' ': false // Spacebar
        };

        // --- Game Constants ---
        const WORLD_WIDTH = 2400; // 3x canvas width
        const WORLD_HEIGHT = 1800; // 3x canvas height

        // Entities config
        const PLAYER_SPEED = 250;
        const PLAYER_SIZE = 32;
        const ENEMY_SPEED = 110;
        const PROJECTILE_SPEED = 450;

        // Assets
        const sprites = {
            player: null,
            token: null,
            tree: null,
            enemy: null,
            powerupArmor: null,
            powerupSpeed: null,
            powerupHealth: null
        };

        // Lore
        const tokensTotal = 5;
        const clues = [
            "First, the Baker took the Golden Corn, dried by the noon sun...",
            "Then came the Spicy Meat, seasoned with the whispers of chili spirits...",
            "He wept tears of joy into the Onions, caramelizing them instantly...",
            "He folded the edges thirteen times, sealing the flavor for eternity...",
            "Finally, he baked it in the Volcano of Crunch. The Legend is real!"
        ];
        let collectedClues = [];

        // --- State Variables ---
        let camera = { x: 0, y: 0 };
        let player = {
            x: 400, y: 300, dir: 1,
            hp: 100, maxHp: 100,
            invulnerable: 0,
            armor: false,
            speedBoost: 0
        };

        let tokens = [];
        let trees = [];
        let obstacles = [];
        let enemies = [];
        let projectiles = [];
        let powerups = [];
        let particles = [];

        let tokensFound = 0;
        let nextShotTime = 0;

        // --- Asset Generation ---
        function generateAssets() {
            // 1. Player (Empanada)
            const pCanvas = document.createElement('canvas');
            pCanvas.width = 32; pCanvas.height = 32;
            const pCtx = pCanvas.getContext('2d');

            pCtx.fillStyle = '#F4C430'; // Crust
            pCtx.beginPath();
            pCtx.arc(16, 20, 14, Math.PI, 0);
            pCtx.fill();
            pCtx.strokeStyle = '#D4A017';
            pCtx.lineWidth = 2;
            pCtx.stroke();
            pCtx.closePath();

            pCtx.fillStyle = '#D4A017'; // Crimp
            for (let i = 0; i < 7; i++) {
                pCtx.beginPath();
                pCtx.arc(4 + (i * 4.5), 20, 3, 0, Math.PI * 2);
                pCtx.fill();
            }
            // Face
            pCtx.fillStyle = '#000';
            pCtx.fillRect(10, 14, 4, 4); pCtx.fillRect(18, 14, 4, 4);
            pCtx.fillStyle = '#FF6347';
            pCtx.fillRect(8, 18, 3, 2); pCtx.fillRect(21, 18, 3, 2);
            sprites.player = pCanvas;

            // 2. Token (Salsa Jar)
            const tCanvas = document.createElement('canvas');
            tCanvas.width = 24; tCanvas.height = 24;
            const tCtx = tCanvas.getContext('2d');
            tCtx.fillStyle = '#FFF'; tCtx.fillRect(6, 4, 12, 16);
            tCtx.strokeStyle = '#AAA'; tCtx.strokeRect(6, 4, 12, 16);
            tCtx.fillStyle = '#FF0000'; tCtx.fillRect(7, 8, 10, 11);
            tCtx.fillStyle = '#008000'; tCtx.fillRect(5, 2, 14, 4);
            sprites.token = tCanvas;

            // 3. Enemies - Multiple Types
            // RA (Easy - hoodie student)
            const raCanvas = document.createElement('canvas');
            raCanvas.width = 32; raCanvas.height = 40;
            const raCtx = raCanvas.getContext('2d');
            raCtx.fillStyle = '#88cc88';
            raCtx.beginPath(); raCtx.arc(16, 12, 10, 0, Math.PI * 2); raCtx.fill();
            raCtx.fillRect(8, 20, 16, 14);
            raCtx.fillStyle = '#eec'; raCtx.fillRect(12, 8, 8, 8);
            raCtx.fillStyle = '#333';
            raCtx.fillRect(13, 11, 2, 2); raCtx.fillRect(17, 11, 2, 2);
            raCtx.fillStyle = '#222'; raCtx.fillRect(10, 34, 5, 6); raCtx.fillRect(17, 34, 5, 6);
            sprites.enemyRA = raCanvas;

            const gradCanvas = document.createElement('canvas');
            gradCanvas.width = 32; gradCanvas.height = 40;
            const gradCtx = gradCanvas.getContext('2d');
            gradCtx.fillStyle = '#6688cc';
            gradCtx.beginPath(); gradCtx.arc(16, 12, 10, 0, Math.PI * 2); gradCtx.fill();
            gradCtx.fillRect(8, 20, 16, 14);
            gradCtx.fillStyle = '#ddc'; gradCtx.fillRect(12, 8, 8, 8);
            gradCtx.fillStyle = '#222';
            gradCtx.fillRect(13, 11, 3, 2); gradCtx.fillRect(17, 11, 3, 2);
            gradCtx.fillStyle = '#500'; gradCtx.globalAlpha = 0.5;
            gradCtx.fillRect(12, 13, 4, 2); gradCtx.fillRect(17, 13, 4, 2);
            gradCtx.globalAlpha = 1.0;
            gradCtx.fillStyle = '#6F4E37';
            gradCtx.fillRect(14, 26, 4, 6);
            gradCtx.fillStyle = '#222'; gradCtx.fillRect(10, 34, 5, 6); gradCtx.fillRect(17, 34, 5, 6);
            sprites.enemyGrad = gradCanvas;

            const profCanvas = document.createElement('canvas');
            profCanvas.width = 32; profCanvas.height = 40;
            const profCtx = profCanvas.getContext('2d');
            profCtx.fillStyle = '#ddc';
            profCtx.beginPath(); profCtx.arc(16, 10, 8, 0, Math.PI * 2); profCtx.fill();
            profCtx.fillStyle = '#888';
            profCtx.fillRect(10, 9, 5, 3); profCtx.fillRect(17, 9, 5, 3);
            profCtx.fillStyle = '#000';
            profCtx.fillRect(12, 10, 2, 1); profCtx.fillRect(18, 10, 2, 1);
            profCtx.fillStyle = '#222';
            profCtx.fillRect(8, 18, 16, 16);
            profCtx.fillStyle = '#fff';
            profCtx.fillRect(14, 20, 4, 10);
            profCtx.fillStyle = '#8B0000';
            profCtx.fillRect(15, 22, 2, 8);
            profCtx.fillStyle = '#333';
            profCtx.fillRect(10, 34, 5, 6); profCtx.fillRect(17, 34, 5, 6);
            sprites.enemyProf = profCanvas;
            sprites.enemy = raCanvas;

            // 4. Powerups
            // Armor (Foil)
            const aCanvas = document.createElement('canvas'); aCanvas.width = 24; aCanvas.height = 24;
            const aCtx = aCanvas.getContext('2d');
            aCtx.fillStyle = '#C0C0C0'; aCtx.fillRect(4, 4, 16, 16);
            aCtx.strokeStyle = '#fff'; aCtx.lineWidth = 2; aCtx.strokeRect(4, 4, 16, 16);
            aCtx.fillStyle = '#fff'; aCtx.fillText('Ag', 6, 18);
            sprites.powerupArmor = aCanvas;

            // Speed (Coffee)
            const sCanvas = document.createElement('canvas'); sCanvas.width = 24; sCanvas.height = 24;
            const sCtx = sCanvas.getContext('2d');
            sCtx.fillStyle = '#6F4E37'; sCtx.fillRect(6, 6, 12, 14); // Cup
            sCtx.fillStyle = '#fff'; sCtx.fillRect(6, 6, 12, 2); // Lid
            sCtx.fillStyle = '#fff'; sCtx.globalAlpha = 0.5;
            sCtx.fillRect(10, 2, 2, 4); sCtx.fillRect(14, 0, 2, 6); // Steam
            sprites.powerupSpeed = sCanvas;

            // Health (First Aid)
            const hCanvas = document.createElement('canvas'); hCanvas.width = 24; hCanvas.height = 24;
            const hCtx = hCanvas.getContext('2d');
            hCtx.fillStyle = '#fff'; hCtx.fillRect(2, 2, 20, 20);
            hCtx.fillStyle = '#f00'; hCtx.fillRect(10, 6, 4, 12); hCtx.fillRect(6, 10, 12, 4);
            sprites.powerupHealth = hCanvas;

            // Tree
            const trCanvas = document.createElement('canvas'); trCanvas.width = 40; trCanvas.height = 40;
            const trCtx = trCanvas.getContext('2d');
            trCtx.fillStyle = '#8B4513'; trCtx.fillRect(16, 20, 8, 20);
            trCtx.fillStyle = '#228B22'; trCtx.fillRect(4, 10, 32, 12); trCtx.fillRect(8, 0, 24, 12);
            sprites.tree = trCanvas;

            const buildCanvas = document.createElement('canvas'); buildCanvas.width = 80; buildCanvas.height = 100;
            const buildCtx = buildCanvas.getContext('2d');
            buildCtx.fillStyle = '#8B4513'; buildCtx.fillRect(0, 20, 80, 80);
            buildCtx.fillStyle = '#fff';
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 4; c++) {
                    buildCtx.fillRect(8 + c * 18, 30 + r * 20, 12, 15);
                }
            }
            buildCtx.fillStyle = '#654321';
            buildCtx.beginPath(); buildCtx.moveTo(0, 20); buildCtx.lineTo(40, 0); buildCtx.lineTo(80, 20); buildCtx.fill();
            buildCtx.fillStyle = '#333';
            buildCtx.fillRect(32, 75, 16, 25);
            sprites.building = buildCanvas;

            const statCanvas = document.createElement('canvas'); statCanvas.width = 40; statCanvas.height = 60;
            const statCtx = statCanvas.getContext('2d');
            statCtx.fillStyle = '#999';
            statCtx.fillRect(8, 40, 24, 20);
            statCtx.fillStyle = '#666';
            statCtx.fillRect(14, 10, 12, 30);
            statCtx.beginPath(); statCtx.arc(20, 10, 6, 0, Math.PI * 2); statCtx.fill();
            statCtx.fillRect(10, 20, 6, 15); statCtx.fillRect(24, 20, 6, 15);
            sprites.statue = statCanvas;
        }

        // --- Setup ---
        function initGame() {
            tokensFound = 0;
            collectedClues = [];
            player.x = 200; player.y = 200;
            player.hp = 100;
            player.armor = false;
            player.speedBoost = 0;

            tokens = [];
            trees = [];
            obstacles = [];
            enemies = [];
            projectiles = [];
            powerups = [];
            particles = [];

            // Generate Trees
            for (let i = 0; i < 150; i++) {
                trees.push({
                    x: Math.random() * (WORLD_WIDTH - 40),
                    y: Math.random() * (WORLD_HEIGHT - 40),
                    w: 40, h: 40
                });
            }

            for (let i = 0; i < 15; i++) {
                obstacles.push({
                    x: Math.random() * (WORLD_WIDTH - 80),
                    y: Math.random() * (WORLD_HEIGHT - 100),
                    w: 80, h: 100,
                    type: 'building'
                });
            }

            for (let i = 0; i < 20; i++) {
                obstacles.push({
                    x: Math.random() * (WORLD_WIDTH - 40),
                    y: Math.random() * (WORLD_HEIGHT - 60),
                    w: 40, h: 60,
                    type: 'statue'
                });
            }

            // Generate Tokens (Spread out)
            while (tokens.length < tokensTotal) {
                let tx = 100 + Math.random() * (WORLD_WIDTH - 200);
                let ty = 100 + Math.random() * (WORLD_HEIGHT - 200);
                let dist = Math.hypot(tx - player.x, ty - player.y);
                if (dist > 300) {
                    tokens.push({ x: tx, y: ty, id: tokens.length, collected: false });
                }
            }

            for (let i = 0; i < 15; i++) spawnEnemy(true, 'RA');
            for (let i = 0; i < 8; i++) spawnEnemy(true, 'GRAD');
            for (let i = 0; i < 4; i++) spawnEnemy(true, 'PROF');

            // Generate Powerups
            for (let i = 0; i < 15; i++) {
                let type = Math.random();
                let pType = 'HEALTH';
                if (type > 0.6) pType = 'SPEED';
                if (type > 0.85) pType = 'ARMOR';

                powerups.push({
                    x: 100 + Math.random() * (WORLD_WIDTH - 200),
                    y: 100 + Math.random() * (WORLD_HEIGHT - 200),
                    type: pType,
                    active: true
                });
            }

            updateHUD();
        }

        function spawnEnemy(farAway, type = 'RA') {
            let ex, ey;
            let safe = false;
            while (!safe) {
                ex = Math.random() * (WORLD_WIDTH - 32);
                ey = Math.random() * (WORLD_HEIGHT - 40);
                let dist = Math.hypot(ex - player.x, ey - player.y);
                if (farAway && dist > 600) safe = true;
                if (!farAway && dist > 400) safe = true;
            }

            let stats = { type: type, x: ex, y: ey };
            if (type === 'RA') {
                stats.hp = 15;
                stats.speed = ENEMY_SPEED * 0.8;
                stats.damage = 15;
            } else if (type === 'GRAD') {
                stats.hp = 25;
                stats.speed = ENEMY_SPEED * 1.0;
                stats.damage = 25;
            } else if (type === 'PROF') {
                stats.hp = 40;
                stats.speed = ENEMY_SPEED * 1.2;
                stats.damage = 35;
            }
            enemies.push(stats);
        }

        function update(dt) {
            if (gameState !== 'PLAY') return;

            // -- Player Movement --
            let dx = 0;
            let dy = 0;
            if (keys.ArrowUp || keys.w) dy = -1;
            if (keys.ArrowDown || keys.s) dy = 1;
            if (keys.ArrowLeft || keys.a) { dx = -1; player.dir = -1; }
            if (keys.ArrowRight || keys.d) { dx = 1; player.dir = 1; }

            if (dx !== 0 && dy !== 0) { dx *= 0.707; dy *= 0.707; }

            let currentSpeed = PLAYER_SPEED;
            if (player.speedBoost > 0) {
                currentSpeed *= 1.5;
                player.speedBoost -= dt;
                if (player.speedBoost <= 0) document.getElementById('powerup-status').innerText = "";
            }

            let newX = player.x + dx * currentSpeed * dt;
            let newY = player.y + dy * currentSpeed * dt;

            newX = Math.max(0, Math.min(WORLD_WIDTH - PLAYER_SIZE, newX));
            newY = Math.max(0, Math.min(WORLD_HEIGHT - PLAYER_SIZE, newY));

            let collides = false;
            for (let tree of trees) {
                if (checkRectCollision(newX, newY, PLAYER_SIZE, PLAYER_SIZE, tree.x, tree.y, tree.w, tree.h)) {
                    collides = true;
                    break;
                }
            }

            if (!collides) {
                for (let obs of obstacles) {
                    if (checkRectCollision(newX, newY, PLAYER_SIZE, PLAYER_SIZE, obs.x, obs.y, obs.w, obs.h)) {
                        collides = true;
                        break;
                    }
                }
            }

            if (!collides) {
                player.x = newX;
                player.y = newY;
            }

            if (player.invulnerable > 0) player.invulnerable -= dt;

            // -- Camera Follow --
            camera.x = player.x - canvas.width / 2 + PLAYER_SIZE / 2;
            camera.y = player.y - canvas.height / 2 + PLAYER_SIZE / 2;
            // Clamp Camera
            camera.x = Math.max(0, Math.min(WORLD_WIDTH - canvas.width, camera.x));
            camera.y = Math.max(0, Math.min(WORLD_HEIGHT - canvas.height, camera.y));

            // -- Combat: Shooting --
            // Use 'Space' key or button
            if (keys[' '] || keys['Space']) {
                if (Date.now() > nextShotTime) {
                    // Shoot cheese
                    let shootDir = player.dir;
                    // If moving vertically only, shoot vertically? Let's stick to X direction for simplicity or facing dir
                    projectiles.push({
                        x: player.x + 16,
                        y: player.y + 16,
                        vx: shootDir * PROJECTILE_SPEED,
                        vy: 0,
                        life: 1.5
                    });
                    nextShotTime = Date.now() + 300; // Fire rate
                }
            }

            // -- Projectiles --
            for (let i = projectiles.length - 1; i >= 0; i--) {
                let p = projectiles[i];
                p.x += p.vx * dt;
                p.y += p.vy * dt;
                p.life -= dt;

                // Hit Enemy?
                let hit = false;
                for (let j = enemies.length - 1; j >= 0; j--) {
                    let e = enemies[j];
                    if (p.x > e.x && p.x < e.x + 32 && p.y > e.y && p.y < e.y + 40) {
                        // Impact
                        e.hp -= 15; // Damage
                        createParticles(e.x + 16, e.y + 20, '#fff', 3);
                        if (e.hp <= 0) {
                            enemies.splice(j, 1);
                            createParticles(e.x + 16, e.y + 20, '#aa0000', 8);
                            // Chance to respawn later to keep pressure
                            setTimeout(() => spawnEnemy(true), 2000);
                        }
                        hit = true;
                        break;
                    }
                }

                if (p.life <= 0 || hit) {
                    projectiles.splice(i, 1);
                }
            }

            // -- Enemies --
            for (let e of enemies) {
                let angle = Math.atan2(player.y - e.y, player.x - e.x);
                e.x += Math.cos(angle) * e.speed * dt;
                e.y += Math.sin(angle) * e.speed * dt;

                if (player.invulnerable <= 0) {
                    if (
                        player.x < e.x + 20 && player.x + 20 > e.x &&
                        player.y < e.y + 30 && player.y + 30 > e.y
                    ) {
                        takeDamage(e.damage);
                    }
                }
            }

            // -- Tokens --
            for (let t of tokens) {
                if (!t.collected) {
                    if (checkCollision(player, t, 24)) {
                        collectToken(t);
                    }
                }
            }

            // -- Powerups --
            for (let p of powerups) {
                if (p.active && checkCollision(player, p, 24)) {
                    activatePowerup(p);
                }
            }

            // -- Particles --
            for (let i = particles.length - 1; i >= 0; i--) {
                let pt = particles[i];
                pt.x += pt.vx; pt.y += pt.vy;
                pt.life -= dt;
                if (pt.life <= 0) particles.splice(i, 1);
            }
        }

        function checkCollision(a, b, size) {
            return a.x < b.x + size && a.x + 32 > b.x &&
                a.y < b.y + size && a.y + 32 > b.y;
        }

        function checkRectCollision(x1, y1, w1, h1, x2, y2, w2, h2) {
            return x1 < x2 + w2 && x1 + w1 > x2 &&
                y1 < y2 + h2 && y1 + h1 > y2;
        }

        function takeDamage(amount) {
            if (player.armor) {
                player.armor = false;
                document.getElementById('powerup-status').innerText = "ARMOR BROKEN!";
                player.invulnerable = 1; // Brief immunity
                createParticles(player.x, player.y, '#C0C0C0', 10);
                return;
            }

            player.hp -= amount;
            player.invulnerable = 1.5;
            createParticles(player.x, player.y, '#F4C430', 5);
            updateHUD();

            if (player.hp <= 0) {
                gameState = 'GAMEOVER';
                document.getElementById('game-over-screen').classList.remove('hidden');
            }
        }

        function activatePowerup(p) {
            p.active = false;
            if (p.type === 'HEALTH') {
                player.hp = Math.min(player.hp + 30, player.maxHp);
                document.getElementById('powerup-status').innerText = "HEALED!";
            } else if (p.type === 'ARMOR') {
                player.armor = true;
                document.getElementById('powerup-status').innerText = "FOIL ARMOR EQUIPPED!";
            } else if (p.type === 'SPEED') {
                player.speedBoost = 5; // 5 seconds
                document.getElementById('powerup-status').innerText = "CAFFEINE RUSH!";
            }
            updateHUD();
            setTimeout(() => document.getElementById('powerup-status').innerText = "", 2000);
        }

        function createParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 100,
                    vy: (Math.random() - 0.5) * 100,
                    color: color,
                    life: 0.5
                });
            }
        }

        function collectToken(token) {
            token.collected = true;
            tokensFound++;
            collectedClues.push(clues[token.id]);
            updateHUD();
            showMessage(clues[token.id]);

            let types = ['RA', 'RA', 'GRAD', 'PROF'];
            spawnEnemy(false, types[Math.floor(Math.random() * types.length)]);
            spawnEnemy(false, types[Math.floor(Math.random() * types.length)]);
        }

        function showMessage(text) {
            gameState = 'DIALOGUE';
            const box = document.getElementById('message-box');
            const txt = document.getElementById('message-text');
            txt.innerHTML = `<span class="clue-text">FOUND SALSA!</span><br><br>${text}`;
            box.style.display = 'flex';
        }

        function closeMessage() {
            document.getElementById('message-box').style.display = 'none';
            if (tokensFound >= tokensTotal) winGame();
            else gameState = 'PLAY';
        }

        function winGame() {
            gameState = 'WIN';
            document.getElementById('win-screen').classList.remove('hidden');
            document.getElementById('final-lore').innerHTML = "<strong>THE SCROLL OF TRUTH:</strong><br><br>" + collectedClues.join('<br><br>');
        }

        function draw() {
            // --- Game World Draw ---
            // Fill background
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            // Apply Camera Transform
            ctx.translate(-camera.x, -camera.y);

            // Ground (Grass)
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(camera.x, camera.y, canvas.width, canvas.height); // Optimization: only draw visible

            // Grid lines to see movement better (optional, but good for large maps)
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.beginPath();
            for (let x = 0; x < WORLD_WIDTH; x += 100) { ctx.moveTo(x, 0); ctx.lineTo(x, WORLD_HEIGHT); }
            for (let y = 0; y < WORLD_HEIGHT; y += 100) { ctx.moveTo(0, y); ctx.lineTo(WORLD_WIDTH, y); }
            ctx.stroke();

            // Trees
            for (let t of trees) {
                if (t.x > camera.x - 50 && t.x < camera.x + canvas.width && t.y > camera.y - 50 && t.y < camera.y + canvas.height)
                    ctx.drawImage(sprites.tree, t.x, t.y);
            }

            for (let obs of obstacles) {
                if (obs.x > camera.x - 100 && obs.x < camera.x + canvas.width && obs.y > camera.y - 120 && obs.y < camera.y + canvas.height) {
                    if (obs.type === 'building') {
                        ctx.drawImage(sprites.building, obs.x, obs.y);
                    } else if (obs.type === 'statue') {
                        ctx.drawImage(sprites.statue, obs.x, obs.y);
                    }
                }
            }

            // Powerups
            for (let p of powerups) {
                if (p.active) {
                    let s = sprites.powerupHealth;
                    if (p.type === 'ARMOR') s = sprites.powerupArmor;
                    if (p.type === 'SPEED') s = sprites.powerupSpeed;
                    ctx.drawImage(s, p.x, p.y);
                }
            }

            // Tokens
            const bob = Math.sin(Date.now() / 200) * 3;
            for (let t of tokens) {
                if (!t.collected) {
                    ctx.drawImage(sprites.token, t.x, t.y + bob);
                    // Arrow pointing to token if far away? Maybe too easy.
                }
            }

            // Enemies
            for (let e of enemies) {
                let sprite = sprites.enemyRA;
                if (e.type === 'GRAD') sprite = sprites.enemyGrad;
                if (e.type === 'PROF') sprite = sprites.enemyProf;
                ctx.drawImage(sprite, e.x, e.y);
                if (e.type === 'PROF' || e.type === 'GRAD') {
                    ctx.fillStyle = '#333';
                    ctx.fillRect(e.x, e.y - 6, 32, 4);
                    ctx.fillStyle = e.type === 'PROF' ? '#ff4444' : '#ff8844';
                    let hpPercent = e.hp / (e.type === 'PROF' ? 40 : 25);
                    ctx.fillRect(e.x, e.y - 6, 32 * hpPercent, 4);
                }
            }

            // Projectiles (Cheese)
            ctx.fillStyle = '#FFA500'; // Cheese orange
            for (let p of projectiles) {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
                ctx.fill();
            }

            // Particles
            for (let pt of particles) {
                ctx.fillStyle = pt.color;
                ctx.globalAlpha = pt.life * 2;
                ctx.fillRect(pt.x, pt.y, 3, 3);
                ctx.globalAlpha = 1.0;
            }

            // Player
            ctx.save();
            ctx.translate(player.x + 16, player.y + 16);
            ctx.scale(player.dir, 1);

            if (player.invulnerable > 0 && Math.floor(Date.now() / 100) % 2 === 0) {
                ctx.globalAlpha = 0.5; // Flash when hit
            }

            ctx.drawImage(sprites.player, -16, -16);

            // Armor visual
            if (player.armor) {
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, 0, 18, 0, Math.PI * 2);
                ctx.stroke();
            }

            ctx.restore();

            ctx.restore(); // End Camera Transform
        }

        function updateHUD() {
            document.getElementById('tokens-found').innerText = tokensFound;
            document.getElementById('hp-fill').style.width = (player.hp / player.maxHp * 100) + '%';
            if (player.hp < 30) document.getElementById('hp-fill').style.background = '#f00';
            else document.getElementById('hp-fill').style.background = '#0f0';
        }

        // --- Loop ---
        function loop(timestamp) {
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            update(dt);
            draw();

            requestAnimationFrame(loop);
        }

        // --- Inputs ---
        window.addEventListener('keydown', e => {
            if (keys.hasOwnProperty(e.key) || keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key] = true;
            if (e.code === 'Space') keys['Space'] = true;
            if ((e.key === ' ' || e.key === 'Enter') && gameState === 'DIALOGUE') closeMessage();
        });

        window.addEventListener('keyup', e => {
            if (keys.hasOwnProperty(e.key) || keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key] = false;
            if (e.code === 'Space') keys['Space'] = false;
        });

        // Touch logic helper
        function bindTouch(selector, keyName) {
            const el = document.querySelector(selector);
            const handleStart = (e) => { e.preventDefault(); keys[keyName] = true; };
            const handleEnd = (e) => { e.preventDefault(); keys[keyName] = false; };
            el.addEventListener('touchstart', handleStart);
            el.addEventListener('touchend', handleEnd);
            el.addEventListener('mousedown', handleStart);
            el.addEventListener('mouseup', handleEnd);
            el.addEventListener('mouseleave', handleEnd);
        }

        bindTouch('.up', 'ArrowUp');
        bindTouch('.down', 'ArrowDown');
        bindTouch('.left', 'ArrowLeft');
        bindTouch('.right', 'ArrowRight');
        bindTouch('.action-btn', 'Space');

        document.getElementById('lore-continue-btn').addEventListener('click', () => {
            document.getElementById('lore-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            gameState = 'START';
        });

        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('start-screen').classList.add('hidden');
            initGame();
            gameState = 'PLAY';
        });

        document.getElementById('close-msg').addEventListener('click', closeMessage);

        document.getElementById('restart-btn').addEventListener('click', () => {
            document.getElementById('win-screen').classList.add('hidden');
            initGame();
            gameState = 'PLAY';
        });

        document.getElementById('retry-btn').addEventListener('click', () => {
            document.getElementById('game-over-screen').classList.add('hidden');
            initGame();
            gameState = 'PLAY';
        });

        generateAssets();
        requestAnimationFrame(loop);

    </script>
</body>

</html>